import validate from "./utils/validate"; import Log from "./constants/log"; function initEid(e = "https://eid.faceid.qq.com") { wx.eidBaseUrl = e, wx.onAppShow(e => { const { scene: o } = e; if (1038 !== o) return; const { referrerInfo: r } = e, { appId: t, extraData: n } = r; if ("wx0e2cb0b052a91c92" !== t || !n) return; const { verifyDone: i, token: a } = n; i && wx.handleEidVerifyDone && wx.eidTokenToCallback && wx.eidTokenToCallback === a && (wx.eidTokenToCallback = "", wx.reportLogToEid({ token: a, event: Log.navigateBackFromEid, errMsg: `从EID核身完成返回，token:${a},verifyDone:${i}` }), console.log("!!!!!!执行回调"), wx.handleEidVerifyDone(n)) }); const o = wx.getSystemInfoSync(), { version: r } = o; wx.reportLogToEid = function (e) { const { token: o = "", event: t = "", errCode: n = "", errMsg: i = "", data: a = "" } = e, s = new Date, d = { Token: o, SourceType: "mp_sdk", SourceVersion: "1.0.1", EnvVersion: r, Timestamp: s.getTime(), Event: t, ErrorCode: "number" == typeof n ? n.toString() : n, ErrorMsg: i, Data: a }; console.log("开始上报日志：", d), wx.request({ url: `${wx.eidBaseUrl}/api/common/ReportEvent`, method: "POST", data: d, success(e) { console.log("上报日志完成：", "payload:", d, "res:", e) } }) } } function startEid(e) { const { data: o, verifyDoneCallback: r } = e; if (!o || !r) return void wx.showModal({ title: "提示", content: "传入的参数有误", showCancel: !1 }); const { token: t } = o; validate(t, "token") ? (wx.handleEidVerifyDone = (e => { const { token: o } = e; wx.navigateBack({ success() { wx.request({ url: `${wx.eidBaseUrl}/api/v1/RegisterEid?token=${o}`, method: "POST", success(e) { const { data: t } = e; wx.reportLogToEid({ token: o, event: !t || 0 !== t.ErrorCode && "0" !== t.ErrorCode ? Log.registerEidFail : Log.registerEid, errCode: t ? t.ErrorCode : "", errMsg: t ? t.ErrorMsg : "" }), r({ token: o, verifyDone: !(!t || 0 !== t.ErrorCode && "0" !== t.ErrorCode) }) }, fail(e) { wx.reportLogToEid({ token: o, event: Log.registerEidFail, errMsg: "注册EID失败" }), console.log(e), r({ token: o, verifyDone: !1 }) } }) } }) }), wx.navigateTo({ url: `/mp_ecard_sdk/index/index?token=${t}` })) : wx.showModal({ title: "提示", content: "传入的token有误", showCancel: !1 }) } module.exports = { initEid: initEid, startEid: startEid };